# Пример создания проекта, двух серверов и трех балансировщиков с правилами TCP, UDP, HTTP, HTTPS и сертификата в менеджере секретов.

Используется два terraform провайдера:
- Selectel - для создания проекта, служебного пользователя и назначения служебного пользователя администратором созданного проекта.
- Openstack - для создания инстансов, сетевой инфраструктуры, двух балансировщиков

Для создания проекта и пользователя сервисный пользователь должен быть наделен правами администратора аккаунта и администратора пользователей.

## Тип балансировщика

Мы поддерживаем несколько конфигураций балансировщика. Выбрать необходимую можно указав имя конфигурации в соответствующей переменной.

* `lb_sngl_flavor_name`, `lb_active_flavor_name` - переменные, в которых необходимо указывать требуемую конфигурации балансировщика

Типы конфигураций балансировщика

* `AMPH1.SNGL.2-1024` - Имя базовой кинфигурации без резервирования, 2vCPU, 1ГБ RAM, 1 инстанс ~ 19500 RPS HTTP, 3000 RPS HTTPS
* `AMPH1.ACT_STNDB.2-1024` - Имя базовой кинфигурации с резервированием, 2vCPU, 1ГБ RAM, 2 инстанса ~ 19500 RPS HTTP, 3000 RPS HTTPS
* `AMPH1.ACT_STNDB.4-2048` - Имя базовой кинфигурации с резервированием, 4vCPU, 2ГБ RAM, 2 инстанса ~ 34000 RPS HTTP, 9000 RPS HTTPS

## Содержание secrets.tfvars

  * `username` - Имя сервисного пользователя.
  * `password` - Пароль сервисного пользователя.
  * `domain_name` - ID аккаунта.
  * `user_password` - Пароль пользователя, который будет создан.

## Пример запуска используя переменные окружения

```sh
terraform init

env \
  TF_VAR_username=USER \
  TF_VAR_password=PASSWORD \
  TF_VAR_domain_name=ACCOUNT_ID \
  TF_VAR_user_password=xxx \
  terraform apply
```

## или файла secrets.tfvars

```sh
  terraform apply -var-file secrets.tfvars
```

## Проверка балансировщика

```sh
  curl $(terraform output -raw single_lb_floating):8080
  curl http://$(terraform output -raw active_lb_floating):8090
```

## Выходные переменные

  * `single_lb_floating` - Публичный IP адрес балансировщика базового типа без резервирования.

  * `active_lb_floating` - Публичный IP адрес балансировщика базового типа с резервированием.

  * `active_lb_with_https_floating` - Публичный IP адрес балансировщика базового типа с резервированием и HTTPS протоколом.

## Генерация SSL сертификата

Для генерации может быть использован скрипт, находящийся в директории ssl_certificate - ```cert_generator.sh```

Результатом его выполнения будут сгенерированные файлы ```srl```, ```crt```, ```csr```, ```key```, которые можно добавить в менеджер сертификатов и использовать при создании HTTPS правил.
