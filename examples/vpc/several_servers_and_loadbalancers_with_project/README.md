# Пример создания проекта, двух серверов и двух балансировщиков с правилами TCP, UDP и HTTP.

Используется два terraform провайдера:
- Selectel - для создания проекта, пользователя и роли.
- Openstack - для создания инстансов, сетевой инфраструктуры, двух балансировщиков
Также может быть использован скрипт для генерации SSL сертификата, для его последующего добавления в менеджер сертификатов и использования при создании HTTPS правила для балансировщика.

## Тип балансировщика

К сожалению, на данный момент невозможно автоматически получить UUID конфигурации балансировщика и поэтому его необходимо указывать вручную.

Внимание! UUID конфигурации балансировщика отличается во всех регионах.

  * `lb_flavor_id` - UUID конфигурации балансировщика, который определяет тип создаваемого балансировщика - базовый, базовый с резервированием, продвинутый с резервированием.
  По умолчанию, если оставить поле пустым, будет создан балансировщик с резервированием - два инстанса на балансировщик.
  При необходимости можно указать UUID конфигурации балансировщика, получить которую можно используя Openstack cli (```openstack loadbalancer flavor list```).
    - AMPH1.SNGL.2-1024 - SINGLE - Один инстанс, без резервирования.
    - AMPH1.ACT_STNDB.2-1024 - ACTIVE_STANDBY - Два инстанса, с резервированием, 2 CPU, 1024MB RAM.
    - AMPH1.ACT_STNDB.4-2048 - ACTIVE_STANDBY - Два увеличенных инстанса, с резервированием, 4 CPU, 2048MB RAM.

## Содержание secrets.tfvars

  * `sel_token` - Ключ API из настроек профиля в панели управления.

  * `user_password` - Пароль пользователя, который будет создан.

## Пример запуска используя переменные окружения

```sh
terraform init

env \
  TF_VAR_sel_token=xxx_yyy \
  TF_VAR_user_password=secret \
  terraform apply
```

## или файла secrets.tfvars

```sh
  terraform apply -var-file secrets.tfvars
```

## Проверка балансировщика

```sh
  curl $(terraform output -raw single_lb_floating):8080
  curl http://$(terraform output -raw active_lb_floating):8090
```

## Выходные переменные

  * `single_lb_floating` - Публичный IP адрес балансировщика базового типа без резервирования.

  * `active_lb_floating` - Публичный IP адрес балансировщика базового типа с резервированием.

## Генерация SSL сертификата

Для генерации может быть использован скрипт, находящийся в директории ssl_certificate - ```cert_generator.sh```

Результатом его выполнения будут сгенерированные файлы ```srl```, ```crt```, ```csr```, ```key```, которые можно добавить в менеджер сертификатов и использовать при создании HTTPS правил.
