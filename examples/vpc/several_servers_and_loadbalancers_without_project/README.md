# Пример создания двух серверов и двух балансировщиков с правилами TCP, UDP и HTTPS с SSL сертификатом с использованием уже существующих пользователя и проекта

Для создания инстансов, сетевой инфраструктуры, двух балансировщиков используется только terraform провайдер Openstack.
Также будет использован скрипт для генерации SSL сертификата, для его последующего использования одним из балансировщиков.

## Тип балансировщика

К сожалению, на данный момент невозможно автоматически получить UUID конфигурации балансировщика и поэтому его необходимо указывать вручную.

Внимание! UUID конфигурации балансировщика отличается во всех регионах.

  * `lb_flavor_id` - UUID конфигурации балансировщика, который определяет тип создаваемого балансировщика - базовый, базовый с резервированием, продвинутый с резервированием.
  По умолчанию, если оставить поле пустым, будет создан балансировщик с резевированием - два инстанса на балансировщик.
  При необходимости можно указать UUID конфигурации балансировщика, получить которую можно используя Openstack cli (```openstack loadbalancer flavor list```).
    - AMPH1.SNGL.2-1024 - SINGLE - Один инстанс, без резервирования.
    - AMPH1.ACT_STNDB.2-1024 - ACTIVE_STANDBY - Два инстанса, с резервированием, 2 CPU, 1024MB RAM.
    - AMPH1.ACT_STNDB.4-2048 - ACTIVE_STANDBY - Два увеличенных инстанса, с резервированием, 4 CPU, 2048MB RAM.

## Содержание secrets.tfvars

  * `project_domain_name` - ID аккаунта.

  * `user_domain_name` - ID аккаунта.

  * `user_name` - Имя существующего пользователя, который имеет доступ в проект.

  * `user_password` - Пароль существующего пользователя.

  * `project_name` - Имя проекта, в котором будут созданы ресурсы.

  * `target_zone` - Зона доступности, в которой будут созданы ресурсы.

## Генерация SSL сертификата

Для генерации может быть использован скрипт, находящийся в директории ssl_certificate - ```cert_generator.sh```

Результатом его выполнения будут сгенерированные файлы ```srl```, ```crt```, ```csr```, ```key```, в том числе файл ```www.test-ssl-octavia.com.p12```, который будет использован при создании контейнера Barbican для последущего добавления его в HTTPS правило балансировщика.

## Пример запуска используя переменные окружения

```sh
terraform init

env \
  TF_VAR_sel_token=xxx_yyy \
  TF_VAR_user_password=secret \
  terraform apply
```

## или файла secrets.tfvars

```sh
  terraform apply -var-file secrets.tfvars
```

## Проверка балансировщика

```sh
  curl $(terraform output -raw single_lb_floating):8080
  curl -k https://$(terraform output -raw active_lb_floating):443
```

## Выходные переменные

  * `single_lb_floating` - Публичный IP адрес балансировщика базового типа без резервирования.

  * `active_lb_floating` - Публичный IP адрес балансировщика базового типа с резервированием и SSL сертификатом.
